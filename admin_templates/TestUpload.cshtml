@{
    var accion = Request.Form["accion"].ToString();
    string id_producto = "";
    var current_id = "";
    var old_title = "";
    var archivos = Request.Files;
    dynamic dir = null;
    var producto = new Dictionary<string, dynamic>(){ 
        {"titulo", Request.Form["titulo"]}, 
        {"precio", Request.Form["precio"]}, 
        {"ref", Request.Form["ref"]}, 
        {"desc", Request.Form["desc"]}

    };
   
    if(accion == "Agregar Producto"){
         
        // Guardado de datos inicio
        try{
        var todb = Database.Open("disco");
        var fecha = DateTime.Now; 
        string command = String.Format(@"INSERT INTO Producto(Titulo, Portada, Precio, Referencia, Descripcion, Fecha_entrada)values(
        '{0}', 'portadas/{1}', {2}, '{3}', '{4}', {5})", 
        producto["titulo"], archivos[0].FileName.ToString(), producto["precio"], producto["ref"], producto["desc"], 
        Convert.ToInt64(fecha.Year.ToString() + fecha.Month.ToString() + fecha.Day.ToString() ) );
        todb.Execute(command);
        id_producto = todb.GetLastInsertId().ToString(); 
        dir = Directory.CreateDirectory(Server.MapPath("/").ToString() + "Producto/" + Request.Form["titulo"].ToString() + id_producto.ToString());
        string exec = "insert into Grabaciones(Titulo, Archivo, Id_producto)values('{0}','{1}',{2})";
        for( var i=1; i < Request.Files.Count; i++ ){

              todb.Execute(String.Format(exec, archivos[i].FileName.ToString(), dir.FullName.ToString() + "/" + archivos[i].FileName.ToString() + id_producto, id_producto));

           } 
        todb.Close();
        }catch(Exception e){
           
           <text>@e.Message.ToString()</text>
       }
        // Guardado de datos finaliza

        // Guardado de archivos inicia
        try{
            var portada = archivos[0];
            portada.SaveAs(Server.MapPath("../portadas/").ToString() + portada.FileName.ToString());
           
            for( var i=1; i < Request.Files.Count; i++ ){

               archivos[i].SaveAs(dir.FullName.ToString() + "/" + archivos[i].FileName);

            }
        }catch(Exception f){

            <text>@f.Message.ToString()</text>

        }
        // Guardado de archivos finaliza
        
        
    }
    else if(accion == "Actulizar Producto"){
        old_title = Request.Form["old_title"].ToString();
        current_id = Request.Form["current_id"].ToString();

        // Guardado de datos inicio
        try{
        var todb = Database.Open("disco");
        var fecha = DateTime.Now; 
        string command = String.Format(@"UPDATE Producto SET Titulo='{0}', Portada='portadas/{1}', Precio={2}, Referencia='{3}', Descripcion='{4}' where Id={5};",
        producto["titulo"], archivos[0].FileName.ToString(), producto["precio"], producto["ref"], producto["desc"], current_id );
        todb.Execute(command);
        id_producto = todb.GetLastInsertId().ToString();
        string exec = "insert into Grabaciones(Titulo, Archivo, Id_producto)values('{0}','{1}',{2})";
        for( var i=1; i < Request.Files.Count; i++ ){

              todb.Execute(String.Format(exec, archivos[i].FileName.ToString(), dir.FullName.ToString() + "/" + archivos[i].FileName, current_id));

           }
        if(Request.Form["toRemove"]!=null){
            
            <text>toRemove is not nulo chevere!</text>
        }
        
        todb.Close();
        }catch(Exception e){
           
           <text>@e.Message.ToString()</text>
       }
        // Guardado de datos finaliza

        // Eliminacion de archivos a sustituir
        var old_carpeta = old_title.ToString() + current_id.ToString();
        var new_carpeta = producto["titulo"] + current_id.ToString();
        Directory.Move(Server.MapPath("/").ToString() + "Producto/" +  old_carpeta, Server.MapPath("/").ToString() + "Producto/" + new_carpeta);
        //var productos = Directory.GetFiles(Server.MapPath("/").ToString() + "Producto/" + new_carpeta);
        FileInfo productos = new FileInfo(Server.MapPath("/").ToString() + "Producto/" + new_carpeta);
        var files = productos.Directory.GetFiles();
        foreach(var file in files){

          if(file.Name.ToString() == old_title.ToString() + current_id.ToString()){
                
                file.Delete();
            }
        }

        // Fin de Eliminacion de archivos a sustituir

        // Guardado de archivos inicia
        try{
            var portada = archivos[0];
            portada.SaveAs(Server.MapPath("../portadas/").ToString() + portada.FileName.ToString());
           
            for( var i=1; i < Request.Files.Count; i++ ){

               archivos[i].SaveAs(dir.FullName.ToString() + "/" + archivos[i].FileName);

            }
        }catch(Exception f){

            <text>@f.Message.ToString()</text>

        }
        // Guardado de archivos finaliza
    }
  
}


@{
/*text>@DateTime.Now.ToFileTime()</text>
<text>@DateTime.FromFileTime(DateTime.Now.ToFileTime()).ToShortDateString()</text>      

<text>@DateTime.Now</text>  

<text>@DateTime.Now.ToFileTimeUtc()</text>  
<text>@DateTime.Now.ToLocalTime()</text> 
<text>@DateTime.Now.ToOADate()</text>  
<text>@DateTime.Now.ToString()</text>  
<text>@DateTime.Now.ToLongTimeString()</text>*/ 
}